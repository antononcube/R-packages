---
title: "SMRMon basic usage"
author: Anton Antonov
date: "```r Sys.Date()```"
output: html_notebook
---

```{r}
library(SMRMon)
library(SparseMatrixRecommender)
library(Matrix)
library(magrittr)
```

# Introduction

This notebook contains basic examples of using the R software monad `SMRMon`.

# Creation

Simple creation:

```{r}
smrObj <-
  SMRMonUnit( data = dfTitanic ) %>%
  SMRMonCreate( itemColumnName = "id", addTagTypesToColumnNamesQ = FALSE )
```


```{r}
colnames(smrObj %>% SMRMonTakeM)
```

# Recommendations by history

```{r}
smrObj <-
  smrObj %>% 
  SMRMonRecommend( history = dfTitanic$id[1:2], nrecs = 6, removeHistoryQ = FALSE ) %>% 
  SMRMonJoinAcross( dfTitanic ) %>% 
  SMRMonEchoValue
```


# Recommendations by profile

```{r}
focusProfile <- c("female", "30", "died")
```

```{r}
smrObj <-
  smrObj %>% 
  SMRMonRecommendByProfile( profile = focusProfile, nrecs = 12 ) %>% 
  SMRMonJoinAcross( dfTitanic ) %>% 
  SMRMonEchoValue
```

```{r}
smrObj <-
  smrObj %>% 
  SMRMonRecommendByProfile( profile =focusProfile, nrecs = 12 ) %>% 
  SMRMonJoinAcross( setNames( dfTitanic, 1:ncol(dfTitanic)), by = c( "id" = "1" ) ) %>% 
  SMRMonEchoValue()
```

```{r}
smrObj %>% 
  SMRMonProveByMetadata( profile = focusProfile, item = "id.668" ) %>% 
  SMRMonTakeValue
```

```{r}
smrObj %>% 
  SMRMonProveByHistory( history = c("id.727", "id.970"), item = "id.668" ) %>% 
  SMRMonTakeValue
```

# Profile finding

```{r}
smrObj <-
  smrObj %>% 
  SMRMonProfile( history = "id.993" ) %>% 
  SMRMonEchoValue()
```

```{r}
 smrObj2 <-
  smrObj %>% 
  SMRMonGetTopRecommendations( nrecs = 12 ) %>% 
  SMRMonJoinAcross( dfTitanic ) %>% 
  SMRMonEchoValue
```

# Reduce recommendation matrix by filtering

```{r}
 smrObj2 <-
  smrObj %>% 
  SMRMonGetMatrixProperty( "dimensions" ) %>% SMRMonEchoValue %>% 
  SMRMonFilterMatrix( profile = c( "3rd", "female" ) ) %>% 
  SMRMonGetMatrixProperty( "dimensions" ) %>% SMRMonEchoValue
```

# Classification

```{r}
smrObj <-
  smrObj %>% 
  SMRMonClassifyByProfile( tagType = "passengerClass", profile = c("female", "died"), nTopNNs = 600 ) %>% 
  SMRMonEchoValue
```

# Tags nearest neighbors

```{r}
smrObj <-
  smrObj %>% 
  SMRMonTagNearestNeighbors( tags = c("20"), tagType = "passengerClass", nrecs = 12, nrecsProfile = 400 ) %>% 
  SMRMonEchoValue
```

# Recommendations with progress

```{r, eval=F}
ids <- sample(dfTitanic$id, 300)
  
pb <- dplyr::progress_estimated(length(ids))

purrr::map_df( ids, function(x) {
  
    pb$tick()$print()
  
    res <- smrObj %>% SMRMonRecommend( x ) %>% SMRMonTakeValue

  })
```

# Turn into an incidence recommender

Convert the recommendation matrix in incidence (0-1) matrix:

```{r}
smrObj3 <- 
  smrObj2 %>% 
  SMRMonApplyTermWeightFunctions( globalWeightFunction = "IDF", localWeightFunction = "None", normalizerFunction = "None" ) 
smrObj3 %>% 
  SMRMonTakeM
```

```{r}
smrObj3 %>% 
  SMRMonApplyTermWeightFunctions( globalWeightFunction = "None", localWeightFunction = "Binary", normalizerFunction = "None" ) %>% 
  SMRMonTakeM
```

